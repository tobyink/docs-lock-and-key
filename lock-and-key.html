<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>Keeping Your Valuables Under Lock and Key</title>
		<meta charset="utf-8" />
	</head>
	<body class="pod">
		<span id="___top"></span>
		<h1><span id="Keeping_Your_Valuables_Under_Lock_and_Key">Keeping Your Valuables Under Lock and Key</span></h1>
		<p>Consider the following fairly simple class, which creates a lookup object for month names:</p>
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="version">v5.24</span><span class="structure">;</span>
  
  <span class="keyword" style="color:#009;font-weight:bold">package</span> <span class="word">Local::MonthList</span> <span class="structure">{</span>
    <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="pragma" style="color:#009">experimental</span> <span class="words" style="color:#333;background-color:#ffc">qw( signatures )</span><span class="structure">;</span>
    
    <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">Class::Tiny</span> <span class="structure">{</span>
      <span class="word">months</span>  <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="prototype">( $self )</span> <span class="structure">{</span> <span class="word">die</span> <span class="double" style="color:#909">"`months` is required"</span> <span class="structure">}</span><span class="operator" style="color:#000;font-weight:bold">,</span>
      <span class="word">_lookup</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="prototype">( $self )</span> <span class="structure">{</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">{</span><span class="word">_lookup</span><span class="structure">}</span> <span class="operator" style="color:#000;font-weight:bold">//=</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">_build_lookup</span> <span class="structure">}</span><span class="operator" style="color:#000;font-weight:bold">,</span>
    <span class="structure">};</span>
    
    <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="pragma" style="color:#009">overload</span> <span class="structure">(</span>
      <span class="literal" style="color:#909">q[bool]</span>  <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="structure">{</span> <span class="number" style="color:#39C">1</span> <span class="structure">}</span><span class="operator" style="color:#000;font-weight:bold">,</span>
      <span class="literal" style="color:#909">q[@{}]</span>   <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="structure">{</span> <span class="core" style="color:#009;font-weight:bold">shift</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span> <span class="structure">}</span><span class="operator" style="color:#000;font-weight:bold">,</span>
      <span class="word">fallback</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="number" style="color:#39C">1</span><span class="operator" style="color:#000;font-weight:bold">,</span>
    <span class="structure">);</span>
    
    <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">_build_lookup</span> <span class="prototype">( $self )</span> <span class="structure">{</span>
      <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$n</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="number" style="color:#39C">0</span><span class="structure">;</span>
      <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">%lookup</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="word">map</span> <span class="structure">{</span>
        <span class="word">lc</span><span class="structure">(</span><span class="magic" style="color:#900;font-weight:bold">$_</span><span class="structure">)</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="operator" style="color:#000;font-weight:bold">++</span><span class="symbol" style="color:#333;background-color:#fcc">$n</span><span class="structure">;</span>
      <span class="structure">}</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="cast" style="color:#f00;font-weight:bold">@*</span><span class="structure">;</span>
      <span class="keyword" style="color:#009;font-weight:bold">return</span> <span class="cast" style="color:#f00;font-weight:bold">\</span><span class="symbol" style="color:#333;background-color:#fcc">%lookup</span><span class="structure">;</span>
    <span class="structure">}</span>
    
    <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">lookup_name</span> <span class="prototype">( $self, $month_name )</span> <span class="structure">{</span>
      <span class="keyword" style="color:#009;font-weight:bold">return</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">_lookup</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">{</span> <span class="word">lc</span> <span class="symbol" style="color:#333;background-color:#fcc">$month_name</span> <span class="structure">};</span>
    <span class="structure">}</span>
    
    <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">lookup_number</span> <span class="prototype">( $self, $month_number )</span> <span class="structure">{</span>
      <span class="keyword" style="color:#009;font-weight:bold">return</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">[</span> <span class="symbol" style="color:#333;background-color:#fcc">$month_number</span> <span class="operator" style="color:#000;font-weight:bold">-</span> <span class="number" style="color:#39C">1</span> <span class="structure">];</span>
    <span class="structure">}</span>
  <span class="structure">}</span></pre>
		<p>It can be used as follows:</p>
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="version">v5.24</span><span class="structure">;</span>
  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">Test2::V0</span><span class="structure">;</span>
  
  <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$list</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="single" style="color:#909">'Local::MonthList'</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="word">months</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="structure">[</span> <span class="words" style="color:#333;background-color:#ffc">qw{
    January   February  March     April     May       June
    July      August    September October   November  December
  }</span> <span class="structure">]</span> <span class="structure">);</span>
  
  <span class="word">is</span><span class="structure">(</span> <span class="symbol" style="color:#333;background-color:#fcc">$list</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">lookup_name</span><span class="structure">(</span> <span class="single" style="color:#909">'augUST'</span> <span class="structure">)</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="number" style="color:#39C">8</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="single" style="color:#909">'lookup_name'</span> <span class="structure">);</span>
  <span class="word">is</span><span class="structure">(</span> <span class="symbol" style="color:#333;background-color:#fcc">$list</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">lookup_number</span><span class="structure">(</span> <span class="number" style="color:#39C">7</span> <span class="structure">)</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="single" style="color:#909">'July'</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="single" style="color:#909">'lookup_number'</span> <span class="structure">);</span>
  
  <span class="word">is</span><span class="structure">(</span>
    <span class="structure">[</span> <span class="symbol" style="color:#333;background-color:#fcc">$list</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="cast" style="color:#f00;font-weight:bold">@*</span> <span class="structure">]</span><span class="operator" style="color:#000;font-weight:bold">,</span>
    <span class="structure">[</span> <span class="words" style="color:#333;background-color:#ffc">qw{
      January   February  March     April     May       June
      July      August    September October   November  December
    }</span> <span class="structure">]</span><span class="operator" style="color:#000;font-weight:bold">,</span>
    <span class="single" style="color:#909">'overloaded as array'</span><span class="operator" style="color:#000;font-weight:bold">,</span>
  <span class="structure">);</span>
  
  <span class="word">done_testing</span><span class="structure">;</span></pre>
		<p>However, there is a potential issue with any class which has attributes that are references to mutable data structures like arrays and hashes.</p>
		<pre class="highlighting-perl">  <span class="word">push</span> <span class="symbol" style="color:#333;background-color:#fcc">$list</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="cast" style="color:#f00;font-weight:bold">@*</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="single" style="color:#909">'Extrember'</span><span class="structure">;</span>     <span class="comment" style="color:#060;font-style:italic"># add an extra month</span></pre>
		<p>Even if we do in fact want to allow users to add extra months, this will invalidate the cached lookup hash held in <code>_lookup</code>, making the <code>lookup_name</code> method no longer work reliably.</p>
		<p>A solution at the API level is to provide a method like this:</p>
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">push_month</span> <span class="prototype">( $self, $month_name )</span> <span class="structure">{</span>
    <span class="word">push</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="cast" style="color:#f00;font-weight:bold">@*</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="symbol" style="color:#333;background-color:#fcc">$month_name</span><span class="structure">;</span>
    <span class="word">delete</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">{</span><span class="word">_lookup</span><span class="structure">};</span>
    <span class="keyword" style="color:#009;font-weight:bold">return</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="structure">;</span>
  <span class="structure">}</span></pre>
		<p>People can add their months via:</p>
		<pre class="highlighting-perl">  <span class="symbol" style="color:#333;background-color:#fcc">$list</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">push_month</span><span class="structure">(</span> <span class="single" style="color:#909">'Extrember'</span> <span class="structure">);</span></pre>
		<p>While this does provide a sanctioned way for people to add months to the list, it doesn't do anything to <i>prevent</i> them adding months (or removing them!) the old way.</p>
		<h2><span id="Internals::SvREADONLY_to_the_rescue">Internals::SvREADONLY to the rescue</span></h2>
		<p><code>Internals::SvREADONLY</code> is a Perl internal function for marking a scalar, array, or hash read-only or not. The first argument is the thing you want to tweak. The second argument is a boolean indicating whether you want to make it read-only (true) or writable (false).</p>
		<p>(The Internals package contains a bunch of functions which are theoretically unstable and experimental, but in practice haven't been changed in a while. Nevertheless a degree of caution should be employed when using its functions. It may be a better idea to use a third-party package which wraps their functionality. Some of these will be explored later in this article.)</p>
		<p>By adding a one line <code>BUILD</code> method (the <code>BUILD</code> method is automatically called by the constructor in classes based on Moose, Mouse, Moo, Class::Tiny, etc) we can lock down the <code>months</code> array:</p>
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">BUILD</span> <span class="prototype">( $self, $arg )</span> <span class="structure">{</span>
    <span class="word">Internals::SvREADONLY</span><span class="structure">(</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="cast" style="color:#f00;font-weight:bold">@*</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="number" style="color:#39C">1</span> <span class="structure">);</span>
  <span class="structure">}</span></pre>
		<p>Our <code>push_month</code> method will need a few changes to be able to alter the read-only array:</p>
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">push_month</span> <span class="prototype">( $self, $month_name )</span> <span class="structure">{</span>
    <span class="word">Internals::SvREADONLY</span><span class="structure">(</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="cast" style="color:#f00;font-weight:bold">@*</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="number" style="color:#39C">0</span> <span class="structure">);</span>
    <span class="word">push</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="cast" style="color:#f00;font-weight:bold">@*</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="symbol" style="color:#333;background-color:#fcc">$month_name</span><span class="structure">;</span>
    <span class="word">Internals::SvREADONLY</span><span class="structure">(</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="cast" style="color:#f00;font-weight:bold">@*</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="number" style="color:#39C">1</span> <span class="structure">);</span>
    <span class="word">delete</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">{</span><span class="word">_lookup</span><span class="structure">};</span>
    <span class="keyword" style="color:#009;font-weight:bold">return</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="structure">;</span>
  <span class="structure">}</span></pre>
		<p>We can test that this has worked:</p>
		<pre class="highlighting-perl">  <span class="structure">{</span>
    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$e</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="word">dies</span> <span class="structure">{</span>
      <span class="word">push</span> <span class="symbol" style="color:#333;background-color:#fcc">$list</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="cast" style="color:#f00;font-weight:bold">@*</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="single" style="color:#909">'Extrember'</span><span class="structure">;</span>
    <span class="structure">};</span>
    <span class="word">like</span> <span class="symbol" style="color:#333;background-color:#fcc">$e</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="regexp">qr/read-only/</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="single" style="color:#909">'dies trying to push onto overloaded array'</span><span class="structure">;</span>
  <span class="structure">}</span>
  
  <span class="structure">{</span>
    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$e</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="word">dies</span> <span class="structure">{</span>
      <span class="word">push</span> <span class="symbol" style="color:#333;background-color:#fcc">$list</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="cast" style="color:#f00;font-weight:bold">@*</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="single" style="color:#909">'Extrember'</span><span class="structure">;</span>
    <span class="structure">};</span>
    <span class="word">like</span> <span class="symbol" style="color:#333;background-color:#fcc">$e</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="regexp">qr/read-only/</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="single" style="color:#909">'dies trying to push onto months array'</span><span class="structure">;</span>
  <span class="structure">}</span></pre>
		<p>One thing to note is that <code>Internals::SvREADONLY</code> is extremely shallow. It will prevent items being added to or removed from the <code>months</code> array, but it doesn't prevent the items on the array being altered.</p>
		<pre class="highlighting-perl">  <span class="symbol" style="color:#333;background-color:#fcc">$list</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">[</span><span class="number" style="color:#39C">0</span><span class="structure">]</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="single" style="color:#909">'Not January?'</span><span class="structure">;</span></pre>
		<p>Applying and removing the read-only flag recursively is left as an exercise to the reader.</p>
		<h2><span id="Sub::Trigger::Lock">Sub::Trigger::Lock</span></h2>
		<p>A while ago I wrote a module that packages up this behaviour for <a class="podlinkpod" href="https://metacpan.org/pod/Moose">Moose</a>, <a class="podlinkpod" href="https://metacpan.org/pod/Mouse">Mouse</a>, <a class="podlinkpod" href="https://metacpan.org/pod/Moo">Moo</a>, and sufficiently-compatible frameworks.</p>
		<p>First of all, let's rewrite our original class using <a class="podlinkpod" href="https://metacpan.org/pod/Moo">Moo</a>.</p>
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">package</span> <span class="word">Local::MonthList</span> <span class="structure">{</span>
    <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">Moo</span><span class="structure">;</span>
    <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">Types::Common</span> <span class="words" style="color:#333;background-color:#ffc">qw( -types )</span><span class="structure">;</span>
    <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="pragma" style="color:#009">experimental</span> <span class="words" style="color:#333;background-color:#ffc">qw( signatures )</span><span class="structure">;</span>
    
    <span class="word">has</span> <span class="word">months</span>   <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="structure">(</span> <span class="word">is</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="single" style="color:#909">'ro'</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="word">isa</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="word">ArrayRef</span> <span class="structure">);</span>
    <span class="word">has</span> <span class="word">_lookup</span>  <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="structure">(</span> <span class="word">is</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="single" style="color:#909">'lazy'</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="word">builder</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="number" style="color:#39C">1</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="word">clearer</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="number" style="color:#39C">1</span> <span class="structure">);</span>
    
    <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="pragma" style="color:#009">overload</span> <span class="structure">(</span>
      <span class="literal" style="color:#909">q[bool]</span>  <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="structure">{</span> <span class="number" style="color:#39C">1</span> <span class="structure">}</span><span class="operator" style="color:#000;font-weight:bold">,</span>
      <span class="literal" style="color:#909">q[@{}]</span>   <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="structure">{</span> <span class="core" style="color:#009;font-weight:bold">shift</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span> <span class="structure">}</span><span class="operator" style="color:#000;font-weight:bold">,</span>
      <span class="word">fallback</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="number" style="color:#39C">1</span><span class="operator" style="color:#000;font-weight:bold">,</span>
    <span class="structure">);</span>
    
    <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">_build__lookup</span> <span class="prototype">( $self )</span> <span class="structure">{</span>
      <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$n</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="number" style="color:#39C">0</span><span class="structure">;</span>
      <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">%lookup</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="word">map</span> <span class="structure">{</span>
        <span class="word">lc</span><span class="structure">(</span><span class="magic" style="color:#900;font-weight:bold">$_</span><span class="structure">)</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="operator" style="color:#000;font-weight:bold">++</span><span class="symbol" style="color:#333;background-color:#fcc">$n</span><span class="structure">;</span>
      <span class="structure">}</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="cast" style="color:#f00;font-weight:bold">@*</span><span class="structure">;</span>
      <span class="keyword" style="color:#009;font-weight:bold">return</span> <span class="cast" style="color:#f00;font-weight:bold">\</span><span class="symbol" style="color:#333;background-color:#fcc">%lookup</span><span class="structure">;</span>
    <span class="structure">}</span>
    
    <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">lookup_name</span> <span class="prototype">( $self, $month_name )</span> <span class="structure">{</span>
      <span class="keyword" style="color:#009;font-weight:bold">return</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">_lookup</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">{</span> <span class="word">lc</span> <span class="symbol" style="color:#333;background-color:#fcc">$month_name</span> <span class="structure">};</span>
    <span class="structure">}</span>
    
    <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">lookup_number</span> <span class="prototype">( $self, $month_number )</span> <span class="structure">{</span>
      <span class="keyword" style="color:#009;font-weight:bold">return</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">[</span> <span class="symbol" style="color:#333;background-color:#fcc">$month_number</span> <span class="operator" style="color:#000;font-weight:bold">-</span> <span class="number" style="color:#39C">1</span> <span class="structure">];</span>
    <span class="structure">}</span>
    
    <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">push_month</span> <span class="prototype">( $self, $month_name )</span> <span class="structure">{</span>
      <span class="word">push</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="cast" style="color:#f00;font-weight:bold">@*</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="symbol" style="color:#333;background-color:#fcc">$month_name</span><span class="structure">;</span>
      <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">_clear_lookup</span><span class="structure">;</span>
      <span class="keyword" style="color:#009;font-weight:bold">return</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="structure">;</span>
    <span class="structure">}</span>
  <span class="structure">}</span></pre>
		<p>As before, it is possible to directly push to the <code>months</code> array:</p>
		<pre class="highlighting-perl">  <span class="word">push</span> <span class="symbol" style="color:#333;background-color:#fcc">$list</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="cast" style="color:#f00;font-weight:bold">@*</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="single" style="color:#909">'Extrember'</span><span class="structure">;</span>     <span class="comment" style="color:#060;font-style:italic"># add an extra month</span></pre>
		<p><a class="podlinkpod" href="https://metacpan.org/pod/Sub%3A%3ATrigger%3A%3ALock">Sub::Trigger::Lock</a> will lock down the attribute:</p>
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">Sub::Trigger::Lock</span> <span class="word">-all</span><span class="structure">;</span>
  <span class="word">has</span> <span class="word">months</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="structure">(</span> <span class="word">is</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="single" style="color:#909">'ro'</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="word">isa</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="word">ArrayRef</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="word">trigger</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="word">Lock</span> <span class="structure">);</span></pre>
		<p>And our <code>push_month</code> method becomes:</p>
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">push_month</span> <span class="prototype">( $self, $month_name )</span> <span class="structure">{</span>
    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$guard</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="word">unlock</span><span class="structure">(</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span> <span class="structure">);</span>
    <span class="word">push</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="cast" style="color:#f00;font-weight:bold">@*</span><span class="operator" style="color:#000;font-weight:bold">,</span> <span class="symbol" style="color:#333;background-color:#fcc">$month_name</span><span class="structure">;</span>
    <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">_clear_lookup</span><span class="structure">;</span>
    <span class="keyword" style="color:#009;font-weight:bold">return</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="structure">;</span>
  <span class="structure">}</span></pre>
		<p>What is this <code>$guard</code> variable? It is an object which will re-lock the <code>$self-&gt;months</code> array after it has gone out of scope.</p>
		<p>While <a class="podlinkpod" href="https://metacpan.org/pod/Sub%3A%3ATrigger%3A%3ALock">Sub::Trigger::Lock</a> doesn't fully recurse into locked data structures, it does go one level deep, which means this is prevented:</p>
		<pre class="highlighting-perl">  <span class="symbol" style="color:#333;background-color:#fcc">$list</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">[</span><span class="number" style="color:#39C">0</span><span class="structure">]</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="single" style="color:#909">'Not January?'</span><span class="structure">;</span></pre>
		<h2><span id="Mite">Mite</span></h2>
		<p><a class="podlinkpod" href="https://metacpan.org/pod/Mite">Mite</a> also makes locking attributes reasonably easy, using <code>locked =&gt; true</code> in the attribute definition. The <code>push_month</code> method can also be included declaratively via Mite's support for <code>handles_via =&gt; 'Array'</code>. The only additional step is an <code>after push_month</code> method modifier to clear the <code>_lookup</code> hashref.</p>
		<pre class="highlighting-perl">  <span class="keyword" style="color:#009;font-weight:bold">package</span> <span class="word">Local2::MonthList</span><span class="structure">;</span>
  
  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="word">Local2::Mite</span> <span class="words" style="color:#333;background-color:#ffc">qw( -default -bool )</span><span class="structure">;</span>
  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="pragma" style="color:#009">experimental</span> <span class="words" style="color:#333;background-color:#ffc">qw( signatures )</span><span class="structure">;</span>
  
  <span class="word">has</span> <span class="word">months</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="structure">(</span>
    <span class="word">is</span>          <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="single" style="color:#909">'ro'</span><span class="operator" style="color:#000;font-weight:bold">,</span>
    <span class="word">isa</span>         <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="single" style="color:#909">'ArrayRef'</span><span class="operator" style="color:#000;font-weight:bold">,</span>
    <span class="word">locked</span>      <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="word">true</span><span class="operator" style="color:#000;font-weight:bold">,</span>
    <span class="word">handles_via</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="single" style="color:#909">'Array'</span><span class="operator" style="color:#000;font-weight:bold">,</span>
    <span class="word">handles</span>     <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="structure">{</span> <span class="word">push_month</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="single" style="color:#909">'push'</span> <span class="structure">}</span><span class="operator" style="color:#000;font-weight:bold">,</span>
  <span class="structure">);</span>
  
  <span class="word">has</span> <span class="word">_lookup</span>  <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="structure">(</span>
    <span class="word">is</span>          <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="single" style="color:#909">'lazy'</span><span class="operator" style="color:#000;font-weight:bold">,</span>
    <span class="word">builder</span>     <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="word">true</span><span class="operator" style="color:#000;font-weight:bold">,</span>
    <span class="word">clearer</span>     <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="word">true</span><span class="operator" style="color:#000;font-weight:bold">,</span>
  <span class="structure">);</span>
  
  <span class="keyword" style="color:#009;font-weight:bold">use</span> <span class="pragma" style="color:#009">overload</span> <span class="structure">(</span>
    <span class="literal" style="color:#909">q[bool]</span>  <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="structure">{</span> <span class="number" style="color:#39C">1</span> <span class="structure">}</span><span class="operator" style="color:#000;font-weight:bold">,</span>
    <span class="literal" style="color:#909">q[@{}]</span>   <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="structure">{</span> <span class="core" style="color:#009;font-weight:bold">shift</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span> <span class="structure">}</span><span class="operator" style="color:#000;font-weight:bold">,</span>
    <span class="word">fallback</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="number" style="color:#39C">1</span><span class="operator" style="color:#000;font-weight:bold">,</span>
  <span class="structure">);</span>
  
  <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">_build__lookup</span> <span class="prototype">( $self )</span> <span class="structure">{</span>
    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">$n</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="number" style="color:#39C">0</span><span class="structure">;</span>
    <span class="keyword" style="color:#009;font-weight:bold">my</span> <span class="symbol" style="color:#333;background-color:#fcc">%lookup</span> <span class="operator" style="color:#000;font-weight:bold">=</span> <span class="word">map</span> <span class="structure">{</span>
      <span class="word">lc</span><span class="structure">(</span><span class="magic" style="color:#900;font-weight:bold">$_</span><span class="structure">)</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="operator" style="color:#000;font-weight:bold">++</span><span class="symbol" style="color:#333;background-color:#fcc">$n</span><span class="structure">;</span>
    <span class="structure">}</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="cast" style="color:#f00;font-weight:bold">@*</span><span class="structure">;</span>
    <span class="keyword" style="color:#009;font-weight:bold">return</span> <span class="cast" style="color:#f00;font-weight:bold">\</span><span class="symbol" style="color:#333;background-color:#fcc">%lookup</span><span class="structure">;</span>
  <span class="structure">}</span>
  
  <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">lookup_name</span> <span class="prototype">( $self, $month_name )</span> <span class="structure">{</span>
    <span class="keyword" style="color:#009;font-weight:bold">return</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">_lookup</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">{</span> <span class="word">lc</span> <span class="symbol" style="color:#333;background-color:#fcc">$month_name</span> <span class="structure">};</span>
  <span class="structure">}</span>
  
  <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="word">lookup_number</span> <span class="prototype">( $self, $month_number )</span> <span class="structure">{</span>
    <span class="keyword" style="color:#009;font-weight:bold">return</span> <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">months</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="structure">[</span> <span class="symbol" style="color:#333;background-color:#fcc">$month_number</span> <span class="operator" style="color:#000;font-weight:bold">-</span> <span class="number" style="color:#39C">1</span> <span class="structure">];</span>
  <span class="structure">}</span>
  
  <span class="word">after</span> <span class="word">push_month</span> <span class="operator" style="color:#000;font-weight:bold">=&gt;</span> <span class="keyword" style="color:#009;font-weight:bold">sub</span> <span class="prototype">( $self, $month_name )</span> <span class="structure">{</span>
    <span class="symbol" style="color:#333;background-color:#fcc">$self</span><span class="operator" style="color:#000;font-weight:bold">-&gt;</span><span class="word">_clear__lookup</span><span class="structure">;</span>
  <span class="structure">};</span>
  
  <span class="number" style="color:#39C">1</span><span class="structure">;</span></pre>
		<h2><span id="Alternative_approaches">Alternative approaches</span></h2>
		<p>An alternative approach to locking attributes is cloning them. The basic idea is whenever somebody requests <code>$list-&gt;months</code>, instead of returning a reference to your internal array, return a deep clone of it.</p>
		<p>This way, if they alter the clone, your internal copy is unaffected.</p>
		<p>A major difference with this approach is that there is no exception thrown when they alter the clone. In some cases, this will be preferable. In others, it may be a source of confusion.</p>
		<p><a class="podlinkpod" href="https://metacpan.org/pod/MooseX%3A%3AExtended">MooseX::Extended</a> offers a <code>clone</code> feature to make this approach easy. <a class="podlinkpod" href="https://metacpan.org/pod/Mite">Mite</a> also supports <code>clone</code>. One drawback is that this can be an expensive operation for large and deeply nested structures.</p>
		<h2><span id="Conclusion">Conclusion</span></h2>
		<p>Locking reference attributes can be a fast and easy way to protect the internal state of your objects.</p>
		<p>Perl has built-in support for read-only arrays and hashes via <code>Internals::SvREADONLY</code>, but modules like <a class="podlinkpod" href="https://metacpan.org/pod/Sub%3A%3ATrigger%3A%3ALock">Sub::Trigger::Lock</a> exist to make using the feature simpler in object-oriented code.</p>
		<p>You can find the full code and test cases for the classes discussed in this module here:</p>
		<p><a class="podlinkurl" href="https://github.com/tobyink/docs-lock-and-key">https://github.com/tobyink/docs-lock-and-key</a>.</p>
	</body>
</html>